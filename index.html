<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Property Valuation</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='lib/bootstrap/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=News+Cycle:400,700|Cabin+Condensed:400,700|Montserrat:400,700' rel='stylesheet' type='text/css'>
	<style>

	body { 
		/*background-image: url(http://farm4.staticflickr.com/3779/11754673356_f8f6c7c5cb_b.jpg); */
		background-attachment: fixed; background-position: 50% 50%; background-repeat: no-repeat no-repeat;
		-webkit-background-size: cover;
		-moz-background-size: cover;
		-o-background-size: cover;
		background-size: cover;
	}

	html,body { font-family: 'Montserrat', sans-serif; height: 100%; }
	h1 { font-family: 'Cabin Condensed', sans-serif; margin:0; }
	h2 { font-family: 'News Cycle', sans-serif; margin: 0.1em 0 0.8em 0; }

	#map-canvas {
		height: 300px;
		position: fixed;
		z-index:0;
	}
	#wrap { min-height: 100%; }
	#main { overflow:auto; padding-bottom: 60px; }
	.footer { 
		display: none;
		font-size: 0.8em;
		position: relative;
		margin-top: -60px;
		height: 60px;
		clear: both;
		padding-top: 8px;
		background-color: rgba(255,255,255,0.9); 
		border-top: 5px solid #fff;		
	}

	#topBrand {
		font-family: 'News Cycle', sans-serif;
		padding: 2em;
		display:inline-block;
		background-color: rgba(255,255,255,0.9); 
		border: 5px solid #fff;
		border-top: 0;
		padding-top:1em;
	}

	#querywin, #result { 
		padding: 2em; 
		background-color: rgba(255,255,255,0.9); 
		margin: 5em 0 0 0; 
		border: 5px solid #fff;	
	}
	#result { display:none; margin: 2em 0; }

	</style>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
	<!-- <div id="map-canvas"></div> -->
	<div id="wrap">
		<div id="main" class="container clear-top">

			<div id="topBrand">
				Offered by:<br>
				<img src="http://solutionsbyimpact.com/images/logo.png"/>
			</div>

			<div id="querywin">
				<form role="form">
					<h1>What is your home worth?</h1>
					<h2>Get a free estimate of the value of your home</h2>

					<div class="row">
						<div class="col-md-8">
							<label class="sr-only" for="address">Enter your address</label>
							<input type="text" name="address" id="address" placeholder="Enter your address" class="form-control"/>
						</div>
						<div class="col-md-3">
							<button type="button" class="btn btn-primary" onclick="fetchProperty()">Get Valuation</button>
						</div>
					</div>
				</form>
			</div>

			<div id="result">

				<div class="row">
					<div class="col-md-4">
						<input value="true" id="skinnyCalc" type="hidden"></input>
						<input value="736c5f" id="skinnyCalcTc" type="hidden"></input>
						<input value="f7f5f4" id="skinnyCalcBgc" type="hidden"></input>

						<div>
							<div id="zillow-shv-js-large-widget1388867792035"></div>
						</div>
					</div>
					<div class="col-md-8">
						<div id="map-canvas"></div>
					</div>
				</div>

			</div>

		</div>
	</div>


	<footer class="footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2"><img src="http://www.zillow.com/widgets/GetVersionedResource.htm?path=/static/logos/Zillowlogo_150x40.gif" width="150" height="40" alt="Zillow Real Estate Search" /></div>
				<div class="col-md-8">
						Listing results: &copy; Zillow, Inc., 2006-2013. Use is subject to <a href="http://www.zillow.com/corp/Terms.htm" target="_blank">Terms of Use</a> <br> <a href="http://www.zillow.com/wikipages/What-is-a-Zestimate/" target="_blank">What's a Zestimate?</a>
				</div>
				<div class="col-md-4"></div>
			</div>
		</div>
	</footer>

<script type="text/javascript" src="http://www.zillow.com/widgets/GetVersionedResource.htm?path=/static/js/src/zillow/widgets/zestimate-js-widget-concat.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrDWIgR2ivRJuGHHpLly88P697sDi5S3c&sensor=true"></script>
<script type="text/javascript" language="javascript">

	var gkey = 'AIzaSyBrDWIgR2ivRJuGHHpLly88P697sDi5S3c';
	var gmap;

	// var uri = "http://api.flickr.com/services/feeds/photos_public.gne?tags=house,street,yard&format=json&lang=en-us&jsoncallback=?";
	var uri = "http://api.flickr.com/services/feeds/groups_pool.gne?id=92575895@N00&format=json&lang=en-us&jsoncallback=?";

	function showWidgets(address, region) {
		if (window.YAHOO && window.YAHOO.zillowwidgets) {
			var uri = 'http://www.zillow.com/widgets/zestimate/ZestimateLargeWidget.htm?did=zillow-shv-js-large-widget1388867792035&type=js&address='+address+'&skinnyWidget=true&tc=736c5f&bgc=f7f5f4&searchbox=no&region='+region+'&callback=YAHOO.zillowwidgets.zestimatewidget.js.launcher';

			console.log(uri);

			YAHOO.zillowwidgets.$G.script(uri);
		} else { 
			 document.getElementById('zillow-shv-js-large-widget1388867792035').innerHTML = '<div style="border:1px solid #adcfff;font-size:12px;color:#555;">We\'ll be back online as soon as possible, but for updates, please check the <a style="font:normal normal normal 12px verdana,arial,sans-serif;color:#3366bb;text-decoration:underline;" href="http://www.zillow.com/blog/" target="_blank">Zillow Blog</a></div>';
		} 

	}

	function initialize() {
	}

	var setMap = function(property) {
		var ltlg = new google.maps.LatLng(property.lat,property.lng);
		var mapOptions = {
			center: ltlg,
			zoom: 17,
			mapTypeId: google.maps.MapTypeId.SATELLITE
		};
		gmap = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
		gmap.setCenter(ltlg);
		gmap.setZoom(18);

		var marker = new google.maps.Marker({
			position: ltlg,
			map: gmap,
			title: 'My House'
		});

		var content = '<strong>' + property.street + ', ' + property.city + ', ' + property.state + ' ' + property.zip + '</strong><br>' +
					'Zestimate &copy;: ' + property.zestimate;


		var infowindow = new google.maps.InfoWindow({
			content: content
		});

		infowindow.open(gmap,marker);

		google.maps.event.addListener(marker, 'click', function() {
			infowindow.open(gmap,marker);
		});

	};

	var setBG = function(data) {
		var l = data.items.length;
		var i = Math.floor((Math.random()*l)+1);
		if (data.items[i]) {
			$('body')[0].style.backgroundImage = 'url('+data.items[i].media.m.replace('_m','_b')+')';
		}
	};

	var fetchProperty = function() {
		var address = $('#address').val().split(',');

		var uri = "/propertySearch?&address="+address.shift()+"&citystatezip="+address.join(',');

		$.get(uri, function(data) {
			var record = JSON.parse(data); 
			var result = record["SearchResults:searchresults"].response[0].results[0].result[0];

			var street = result.address[0].street[0];
			var city = result.address[0].city[0];
			var state = result.address[0].state[0]
			var zip = result.address[0].zipcode[0];
			var lat = result.address[0].latitude[0];
			var lng = result.address[0].longitude[0];

			var zestimate = result.zestimate[0].amount[0]._;
			console.log(zestimate);

			var widgetAddress = encodeURIComponent(street + ',' + zip);
			var widgetRegion = encodeURIComponent(city);

			$('#result').show();
			$('.footer').show();
			showWidgets(widgetAddress, widgetRegion);
			setMap({
				street: street,
				city: city,
				state: state,
				zip: zip,
				lat: lat,
				lng: lng,
				zestimate: zestimate
			});
			// $('#result').html(JSON.stringify(result, undefined, 2));

      		// google.maps.event.addDomListener(window, 'load', initialize);
		});
	};

	$(document).ready(function(){

		$.ajax({
			url: uri,
			dataType: "jsonp",
			crossDomain: "true",
			jsonpCallback: 'setBG'
		});

	});
	</script>
</body>
</html>